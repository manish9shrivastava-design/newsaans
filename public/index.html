<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SAANS Data Capture</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="p-3">

<h3>SAANS Data Capture Form</h3>

<form id="captureForm" class="mb-3">
  <div class="row g-3">
    <div class="col-md-3"><label>Month</label><input type="text" class="form-control" name="Month" required /></div>
    <div class="col-md-3"><label>Name of the Block</label><input type="text" class="form-control" name="BlockName" required /></div>
    <div class="col-md-6"><label>Name of Nodal Officer Incharge</label><input type="text" class="form-control" name="NodalOfficer" required /></div>
    <div class="col-md-4"><label>SAANS inaugurated at District Level?</label>
      <select class="form-select" name="DistrictInaugurated" required>
        <option value="">Select</option><option value="Yes">Yes</option><option value="No">No</option>
      </select>
    </div>
    <div class="col-md-4"><label>Number of Blocks that inaugurated SAANS</label><input type="number" class="form-control" name="BlocksInaugurated" min="0" /></div>
    <div class="col-md-4"><label>No. of ASHAs trained on home visits</label><input type="number" class="form-control" name="ASHAsTrained" min="0" /></div>
    <div class="col-md-4"><label>No. of ANMS trained on SAANS</label><input type="number" class="form-control" name="ANMsTrained" min="0" /></div>
    <div class="col-md-4"><label>No. of Nursing Officers trained on SAANS</label><input type="number" class="form-control" name="NursingOfficersTrained" min="0" /></div>
    <div class="col-md-4"><label>No. of Doctors trained on SAANS</label><input type="number" class="form-control" name="DoctorsTrained" min="0" /></div>
    <div class="col-md-4"><label>No. of ASHAs with house visits of under-five children</label><input type="number" class="form-control" name="ASHAsHouseVisits" min="0" /></div>
    <div class="col-md-4"><label>No. under-five children assessed by ASHAs for symptoms</label><input type="number" class="form-control" name="UnderFiveAssessedByASHAs" min="0" /></div>
    <div class="col-md-4"><label>No. under-five children assessed by ANM/Staff Nurse/Medical Officer</label><input type="number" class="form-control" name="UnderFiveAssessedByANM" min="0" /></div>
    <div class="col-md-4"><label>No. under-five children administered pre-referral medication</label><input type="number" class="form-control" name="UnderFiveMedicated" min="0" /></div>
    <div class="col-md-4"><label>No. under-five children referred to health facility by ASHA/ANM</label><input type="number" class="form-control" name="UnderFiveReferred" min="0" /></div>
    <div class="col-md-4"><label>No. houses with at least 1 risk factor identified</label><input type="number" class="form-control" name="HousesWithRiskFactors" min="0" /></div>
    <div class="col-md-4"><label>No. homes counseled using M4M approach</label><input type="number" class="form-control" name="HomesCounseledM4M" min="0" /></div>
    <div class="col-md-4"><label>No. under-five children treated with cough syrup/ORS at community level</label><input type="number" class="form-control" name="UnderFiveTreatedCoughORS" min="0" /></div>
    <div class="col-md-4"><label>No. under-five children treated with Pneumonia treatment at community/PHC level</label><input type="number" class="form-control" name="UnderFiveTreatedPneumonia" min="0" /></div>
    <div class="col-md-4"><label>No. under-five children treated with Severe Pneumonia as per protocol</label><input type="number" class="form-control" name="UnderFiveTreatedSeverePneumonia" min="0" /></div>
    <div class="col-md-4"><label>No. under-five children administered medication as per guidelines</label><input type="number" class="form-control" name="UnderFiveMedGuidelines" min="0" /></div>
    <div class="col-md-4"><label>No. Skill Stations functional against approval</label><input type="number" class="form-control" name="SkillStationsFunctional" min="0" /></div>
    <div class="col-md-4"><label>Infants given PCV-1 vs eligible</label><input type="text" class="form-control" name="InfantsGivenPCV1" /></div>
    <div class="col-md-4"><label>Infants given PCV-Booster vs eligible</label><input type="text" class="form-control" name="InfantsGivenPCVBooster" /></div>
  </div>
  <button type="submit" class="btn btn-primary mt-3">Add Data</button>
</form>

<h3>Captured Data</h3>
<table class="table table-bordered table-sm" id="dataTable">
  <thead class="table-light">
    <tr>
      <th>#</th><th>Month</th><th>Block Name</th><th>Nodal Officer</th><th>District Inaug.</th><th>Blocks Inaug.</th><th>ASHAs Trained</th>
      <th>ANMs Trained</th><th>Nursing Officers</th><th>Doctors Trained</th><th>ASHAs House Visits</th><th>Under 5 Assessed ASHAs</th>
      <th>Under 5 Assessed ANM</th><th>Medicated</th><th>Referred</th><th>Houses Risk Factors</th><th>Homes Counseled M4M</th>
      <th>Treated Cough/ORS</th><th>Treated Pneumonia</th><th>Treated Severe Pneumonia</th><th>Medication Guidelines</th><th>Skill Stations</th>
      <th>PCV-1</th><th>PCV-Booster</th><th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<button id="downloadBtn" class="btn btn-success">Download CSV</button>

<script>
<script>
const form = document.getElementById('captureForm');
const tableBody = document.querySelector('#dataTable tbody');

async function fetchData() {
  const res = await fetch('/data');
  const data = await res.json();
  renderTable(data);
}

function renderTable(data) {
  tableBody.innerHTML = '';
  data.forEach((row, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td contenteditable data-field="Month">${row.Month || ''}</td>
      <td contenteditable data-field="BlockName">${row.BlockName || ''}</td>
      <td contenteditable data-field="NodalOfficer">${row.NodalOfficer || ''}</td>
      <td contenteditable data-field="DistrictInaugurated">${row.DistrictInaugurated || ''}</td>
      <td contenteditable data-field="BlocksInaugurated">${row.BlocksInaugurated || ''}</td>
      <td contenteditable data-field="ASHAsTrained">${row.ASHAsTrained || ''}</td>
      <!-- keep all the remaining fields with “|| ''” the same way -->
      <td><button class="btn btn-sm btn-primary save-btn">Save</button></td>
    `;
    tr.querySelector('.save-btn').onclick = () => saveRow(i, tr);
    tableBody.appendChild(tr);
  });
}

async function saveRow(index, rowElement) {
  const updatedData = {};
  rowElement.querySelectorAll('[contenteditable]').forEach(cell => {
    updatedData[cell.dataset.field] = cell.textContent.trim();
  });
  const res = await fetch('/data/' + index, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(updatedData)
  });
  if (res.ok) {
    alert('Row updated');
    fetchData();
  } else {
    alert('Error updating row');
  }
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData(form);
  const obj = {};
  formData.forEach((value, key) => obj[key] = value);
  const res = await fetch('/data', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(obj)
  });
  if (res.ok) {
    form.reset();
    fetchData();   // this is what repopulates the table
  } else {
    alert('Error adding data');
  }
});
function downloadCSV() {
  fetch('/data')
    .then(res => res.json())
    .then(data => {
      if (!data || !data.length) {
        alert('No data to download');
        return;
      }
      const keys = Object.keys(data[0]);
      const csvLines = [
        keys.join(','),                                    // header
        ...data.map(row => keys
          .map(k => `"${(row[k] ?? '').toString().replace(/"/g, '""')}"`)
          .join(',')
        )
      ];
      const blob = new Blob([csvLines.join('\n')], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'saans_data.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    })
    .catch(err => {
      console.error(err);
      alert('Error generating CSV');
    });
}

document.getElementById('downloadBtn').addEventListener('click', downloadCSV);

// initial load
fetchData();
</script>

</script>

</body>
</html>

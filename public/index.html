<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SAANS Data Capture</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="p-3">

<h3>SAANS Data Capture Form</h3>

<form id="captureForm" class="mb-3">
  <div class="row g-3">
    <!-- Fields based on provided Excel columns -->
    <div class="col-md-3">
      <label>Month</label>
      <input type="text" class="form-control" name="Month" required />
    </div>
    <div class="col-md-3">
      <label>Name of the Block</label>
      <input type="text" class="form-control" name="BlockName" required />
    </div>
    <div class="col-md-6">
      <label>Name of Nodal Officer Incharge</label>
      <input type="text" class="form-control" name="NodalOfficer" required />
    </div>
    <div class="col-md-4">
      <label>SAANS inaugurated at District Level?</label>
      <select class="form-select" name="DistrictInaugurated" required>
        <option value="">Select</option>
        <option value="Yes">Yes</option>
        <option value="No">No</option>
      </select>
    </div>
    <div class="col-md-4">
      <label>Number of Blocks that inaugurated SAANS</label>
      <input type="number" class="form-control" name="BlocksInaugurated" min="0" />
    </div>
    <div class="col-md-4">
      <label>No. of ASHAs trained on home visits</label>
      <input type="number" class="form-control" name="ASHAsTrained" min="0" />
    </div>

    <!-- Add remaining fields similarly... (For brevity including main fields here; you can add all 23 fields similarly) -->
  </div>

  <button type="submit" class="btn btn-primary mt-3">Add Data</button>
</form>

<h3>Captured Data</h3>
<table class="table table-bordered table-sm" id="dataTable">
  <thead class="table-light">
    <tr>
      <th>#</th>
      <th>Month</th>
      <th>Block Name</th>
      <th>Nodal Officer</th>
      <th>District Inaugurated</th>
      <th>Blocks Inaugurated</th>
      <th>ASHAs Trained</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<button id="downloadBtn" class="btn btn-success">Download CSV</button>

<script>
const form = document.getElementById('captureForm');
const tableBody = document.querySelector('#dataTable tbody');
let editIndex = -1;

const fetchData = async () => {
  const res = await fetch('/data');
  const data = await res.json();
  renderTable(data);
};

const renderTable = (data) => {
  tableBody.innerHTML = '';
  data.forEach((row, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = \`
      <td>\${i+1}</td>
      <td contenteditable data-field="Month">\${row.Month}</td>
      <td contenteditable data-field="BlockName">\${row.BlockName}</td>
      <td contenteditable data-field="NodalOfficer">\${row.NodalOfficer}</td>
      <td contenteditable data-field="DistrictInaugurated">\${row.DistrictInaugurated}</td>
      <td contenteditable data-field="BlocksInaugurated">\${row.BlocksInaugurated}</td>
      <td contenteditable data-field="ASHAsTrained">\${row.ASHAsTrained}</td>
      <td><button class="btn btn-sm btn-primary save-btn">Save</button></td>
    \`;
    tr.querySelector('.save-btn').onclick = () => saveRow(i, tr);
    tableBody.appendChild(tr);
  });
};

const saveRow = async (index, rowElement) => {
  const updatedData = {};
  rowElement.querySelectorAll('[contenteditable]').forEach(cell => {
    updatedData[cell.dataset.field] = cell.textContent.trim();
  });
  const res = await fetch('/data/' + index, {
    method: 'PUT',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(updatedData)
  });
  if (res.ok) {
    alert('Row updated');
    fetchData();
  } else {
    alert('Error updating row');
  }
};

form.onsubmit = async (e) => {
  e.preventDefault();
  const formData = new FormData(form);
  const obj = {};
  formData.forEach((value, key) => obj[key] = value);
  const res = await fetch('/data', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(obj)
  });
  if (res.ok) {
    form.reset();
    fetchData();
  }
};

const downloadCSV = () => {
  fetch('/data')
    .then(res => res.json())
    .then(data => {
      if (data.length === 0) return;
      const keys = Object.keys(data[0]);
      const csv = [
        keys.join(','),
        ...data.map(row => keys.map(k => \`"\${row[k] || ''}"\`).join(','))
      ].join('\\n');
      const blob = new Blob([csv], {type: 'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'saans_data.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
    });
};

document.getElementById('downloadBtn').onclick = downloadCSV;

fetchData();
</script>

</body>
</html>
